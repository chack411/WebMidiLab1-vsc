<!--
Copyright (c) 2015 Ryoya Kawai. All rights reserved.
Distributed under the MIT License (license terms are at http://opensource.org/licenses/MIT).
-->
<dom-module id="wm-fireworks">
  <style>
  div#sky-canvas {
    width:800px; height:450px;
    background:-webkit-gradient(linear, left top, left bottom, from(rgba(0, 0, 0, 1)), 
                                color-stop(0.7, rgba(10, 10, 10, 1)), to(rgba(40, 40, 40, 1)));
    overflow:hidden;
  }
  div#firework-canvas {
    position:absolute;
    width:800px; height:450px;
    background-color:rgba(254, 254 ,254, 0);
    overflow:hidden;
    background:url("./images/background.png") no-repeat right bottom;
  }
  div.firework {
    position:absolute;
    left:400px;
    top:400px;
    width:0px; height:0px;
    border-radius:50%;
    /*background-color:rgba(255, 255, 255, 1);*/
  }
  div.firework-left {
    -webkit-animation:fireworkrise-left 2s ease 0s 1 normal;
  }
  div.firework-right {
    -webkit-animation:fireworkrise-right 2s ease 0s 1 normal;
  }
  div.color-radiusgrad {
    background:radial-gradient(rgba(255, 120, 0, 1) 0, rgba(0, 0, 0, 0.1) 70%);
  }
  /* http://web.canon.jp/technology/kids/mystery/m_04_11.html */
  div.color-radiusgrad-00 {
    /* litium */
    background:radial-gradient(rgba(255, 58, 120, 1) 0, rgba(255, 255, 255, 0.4) 70%, rgba(0, 0, 0, 0.1) 100%);
  }
  div.color-radiusgrad-01 {
    /* strontium */
    background:radial-gradient(rgba(211, 31,2, 1) 0, rgba(255, 255, 255, 0.4) 70%, rgba(0, 0, 0, 0.1) 100%);
  }
  div.color-radiusgrad-02 {
    /* calcium */
    background:radial-gradient(rgba(254, 130, 3, 1) 0, rgba(255, 255, 255, 0.4) 70%, rgba(0, 0, 0, 0.1) 100%);
  }
  div.color-radiusgrad-03 {
    /* natrium */
    background:radial-gradient(rgba(254, 230, 35, 1) 0, rgba(255, 255, 255, 0.4) 70%, rgba(0, 0, 0, 0.1) 100%);
  }
  div.color-radiusgrad-04 {
    /* balium */
    background:radial-gradient(rgba(144, 192, 232, 1) 0, rgba(255, 255, 255, 0.4) 70%, rgba(0, 0, 0, 0.1) 100%);
  }
  div.color-radiusgrad-05 {
    /* copper */
    background:radial-gradient(rgba(62, 253, 173, 1) 0, rgba(255, 255, 255, 0.4) 70%, rgba(0, 0, 0, 0.1) 100%);
  }
  div.color-radiusgrad-06 {
    /* cecium */
    background:radial-gradient(rgba(113, 89, 248, 1) 0, rgba(255, 255, 255, 0.4) 70%, rgba(0, 0, 0, 0.1) 100%);
  }
  div.color-radiusgrad-07 {
    /* karium */
    background:radial-gradient(rgba(212, 140, 209, 1) 0, rgba(255, 255, 255, 0.4) 70%, rgba(0, 0, 0, 0.1) 100%);
  }
  div.color-radiusgrad-08 {
    /* lubigium */
    background:radial-gradient(rgba(127, 97, 212, 1) 0, rgba(255, 255, 255, 0.4) 70%, rgba(0, 0, 0, 0.1) 100%);
  }
  @keyframes fireworkrise-left {
    0% { top:450px; }
    1% { width:10px; height:10px; opacity:1; }
    75% { left:405px; opacity:0.7; }
    100% { left:407px; top:350px;  width:10px; height:10px; opacity:0; }
  }
  @keyframes fireworkrise-right {
    0% { top:450px; }
    1% { width:10px; height:10px; opacity:1; }
    75% { left:395px; opacity:0.7; }
    100% { left:393px; top:350px;  width:10px; height:10px; opacity:0; }
  }
  @keyframes firework-on {
    0% {opacity: 0; transform:scale(0);}
    25% {opacity: 0.8;}
    58% {opacity: 1.0; transform:scale(1);}
    60% {opacity: 0.6; transform:scale(0.99);}
    80% {opacity: 0.3;}
    100% {opacity: 0; transform:scale(0.9) translateY(10px);}
  }
  @keyframes a-firework-dot-0 {
    0% {width:0px; height:0px;}
    40% {width:5px; height:5px;}
    60% {width:5px; height:5px;}
    100% {width:0px; height:0px;}
  }
  @keyframes a-firework-dot-1 {
    0% {width:0px; height:0px;}
    40% {width:5px; height:5px;}
    60% {width:5px; height:5px;}
    70% {width:1px; height:1px;}
    75% {width:5px; height:5px;}
    80% {width:1px; height:1px;}
    85% {width:5px; height:5px;}
    90% {width:1px; height:1px;}
    100% {width:0px; height:0px;}
  }

  // for -webkit-
  @-webkit-keyframes fireworkrise-left {
    0% { top:450px; }
    1% { width:10px; height:10px; opacity:1; }
    75% { left:405px; opacity:0.7; }
    100% { left:407px; top:350px;  width:10px; height:10px; opacity:0; }
  }
  @-webkit-keyframes fireworkrise-right {
    0% { top:450px; }
    1% { width:10px; height:10px; opacity:1; }
    75% { left:395px; opacity:0.7; }
    100% { left:393px; top:350px;  width:10px; height:10px; opacity:0; }
  }
  @-webkit-keyframes firework-on {
    0% {opacity: 0; transform:scale(0);}
    25% {opacity: 0.8;}
    58% {opacity: 1.0; transform:scale(1);}
    60% {opacity: 0.6; transform:scale(0.99);}
    80% {opacity: 0.3;}
    100% {opacity: 0; transform:scale(0.9) translateY(10px);}
  }
  @-webkit-keyframes a-firework-dot-0 {
    0% {width:0px; height:0px;}
    40% {width:5px; height:5px;}
    60% {width:5px; height:5px;}
    100% {width:0px; height:0px;}
  }
  @-webkit-keyframes a-firework-dot-1 {
    0% {width:0px; height:0px;}
    40% {width:5px; height:5px;}
    60% {width:5px; height:5px;}
    70% {width:1px; height:1px;}
    75% {width:5px; height:5px;}
    80% {width:1px; height:1px;}
    85% {width:5px; height:5px;}
    90% {width:1px; height:1px;}
    100% {width:0px; height:0px;}
  }

  img#moon {
    position:relative;
    margin:30px 0px 0px 30px;
  }

  @keyframes test00{
    0% {width:100px; height:100px; left:0px;}
    50% {width:50px; height:50px; left:100px;}
    100% {width:100px; height:100px; left:0px;}
  }
  .test {
    position:absolute;
    background-color:red;
    width:100px; height:100px;
    -webkit-animation: test00 4s ease 2s 1 normal;
  }
  </style>
  <template>
    <div id="sky-canvas">
      <div id="firework-canvas">
        <img id="moon" src="./images/moon.png">
      </div>
    </div>
  </template>
</dom-module>
<script type="text/javascript">
Polymer({
    is: "wm-fireworks",
    properties: {
    },
    ready: function() {
        this.fireworksCount=0;
        this.fwCanvasWidth=800;
        this.isPlaying=0;
        this.playingMax=10;
    },
    fireon: function(mode, message) {
        if(typeof message=="undefined") {
            message=mode;
            mode="normal";
        }
        if(this.isPlaying>this.playingMax) {
            console.info("[info] Exeeded max count.");
            return {"status": false };
        }

        this.isPlaying++;

        var aa=Math.floor(2*Math.random())%2==1 ? -1 : 1;
        var fireColorType=("00"+Math.floor(8.9*Math.random())).substr(-2);

        var top_pos=0, left_pos=0;
        switch(mode) {
            case "midi":
                if(message[0].toString(16).substr(0, 1)=="9") {
                    pos_tmp=message[1]%12;
                    left_tmp=(pos_tmp*this.fwCanvasWidth/(12+2))+aa*(100*Math.random());
                    //top_tmp=(100+aa*parseInt(Math.random()*100, 10));  // move top-bottom
                    top_tmp=350-350*(message[2]/127)+aa*(80*Math.random());
                    //fireColorType=("00"+Math.floor(8.9*(message[2]/127))).substr(-2);
                } else {
                    return {"status": true, "type":"stop"};
                }
                break;
            case "normal":
                default:
                top_tmp=(100+aa*parseInt(Math.random()*100, 10));  // move top-bottom
                left_tmp=(300+aa*parseInt(Math.random()*400, 10)); // move right-left
                if(left_tmp<-100) left_tmp=(100+aa*parseInt(Math.random()*100));
                if(left_tmp>750) left_tmp=(500+aa*parseInt(Math.random()*100));
                break;
        }
        top_pos=top_tmp;  // move top-bottom
        left_pos=left_tmp; // move right-left

        var direction=Math.floor(2*Math.random())%2==1 ? "left" : "right";
        var fwelem=document.createElement("div");
        fwelem.id="firework-"+this.fireworksCount;
        fwelem.className="style-scope wm-fireworks firework color-radiusgrad firework-"+direction;
        this.$["firework-canvas"].appendChild(fwelem);
        
        var fw=document.createElement("div");
        fw.id="firework-id-"+this.fireworksCount;
        fw.style.width="210px";
        fw.style.height="210px";
        fw.style.position="absolute";
        fw.style.top=top_pos;
        fw.style.left=left_pos;
//        fw.style.top=(100+aa*parseInt(Math.random()*100, 10));  // move top-bottom
//        fw.style.left=(300+aa*parseInt(Math.random()*400, 10)); // move right-left
//        if(fw.style.left.replace("px", "")<-100) fw.style.left=(100+aa*parseInt(Math.random()*100));
//        if(fw.style.left.replace("px", "")>750)  fw.style.left=(500+aa*parseInt(Math.random()*100));

        fw.style.border="0px solid rgba(255, 255, 255, 1)";
        fw.style.opacity="0";
        fw.style.transform="scale(0)";
        fw.style.setProperty("-webkit-animation", "firework-on 4s ease 2s 1 normal");

        var c_radius_px=100;
        var ptcCount=Math.floor(0.4*c_radius_px+Math.ceil(5*Math.random()));
        var radiusCount=9+Math.ceil(4*Math.random());
        var colorClass="style-scope wm-fireworks color-radiusgrad-"+fireColorType;
        var typeFireAfter=Math.floor(4*Math.random())>1 ? "0" : "1";
        for(var i=1; i<radiusCount; i++) {
            var c_radius=i*(c_radius_px/radiusCount);
            for(var j=0; j<parseInt(ptcCount+(i*i*0.4), 10); j++) {
                var aa=Math.floor(2*Math.random())%2==1 ? -1 : 1;
                aa=aa*4.5*Math.random();
                var ptc=document.createElement("div");
                ptc.style.width="0px", ptc.style.height="0px";
                ptc.style.position="absolute";
                ptc.style.top=aa+c_radius_px+(c_radius*Math.cos(j*(360/ptcCount)/180 * Math.PI))+"px", 
                ptc.style.left=aa+c_radius_px+(c_radius*Math.sin(j*(360/ptcCount)/180 * Math.PI))+"px";
                ptc.style.borderRadius="50%";
                ptc.className=colorClass;
                ptc.style.setProperty("-webkit-animation", "a-firework-dot-"+typeFireAfter+" 4s ease 2s 1 normal");
                fw.appendChild(ptc);
            }
        }
        this.$["firework-canvas"].appendChild(fw);

        // remove forework element
        var self=this;
        setTimeout(function(){
            fw.parentNode.removeChild(fw);
            fwelem.parentNode.removeChild(fwelem);
            self.isPlaying--;
        }, 7000);


        // play sound
        if(mode=="midi") {
            var out=[
                {"msg":[0xc9, 0x10], "timing":0},
                {"msg":[0x99, 0x24, 0x33], "timing":0},
                {"msg":[0x89, 0x24, 0x33], "timing":0+10},
            ];
            var note=[0x24, 0x29, 0x2b, 0x2d];
            for(var i=0; i<13; i++) {
                var pnote=note[Math.floor((note.length-1)*Math.random())];
                var timing=2500+parseInt(Math.random()*200, 10);
                out.push({"msg":[0x99, pnote, 0x33], "timing":timing});
                out.push({"msg":[0x89, pnote, 0x33], "timing":parseInt(timing)+10});
            }
            if(typeFireAfter=="1") {
                out.push({"msg":[0xc1, 0x7e], "timing":0});
                out.push({"msg":[0x91, 0x30, 0x23], "timing":4400});
                out.push({"msg":[0x81, 0x30, 0x00], "timing":6200});
            }
            return {"status": true, "type":"play", "data":out};
        }

    }
});
</script>
